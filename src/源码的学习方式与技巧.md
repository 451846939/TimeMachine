# 源码的学习方式与技巧

平时我们听的很多人喜欢把源码挂在嘴边，比如：linux源码、spring源码、容器源码

在面试的时候有的面试官也很喜欢去问一些源码

那么我们为什么要学习源码呢，学习了源码可以带给我们什么呢，应该如何去阅读源码呢？

这里浅浅的分享一下个人的一些心得体会

## 一、为什么要学习源码

源码，实际上是计算机工程实现的体现，如何把理论化为实现，每个人的思路都不一样，不同源码的实现也有不同的思路，有各自的优点与缺点，计算机有如今的成就，个人认为是综合学科的开花形成的。

源码可以让我们充分了解理论化为工程实现的困难和工程实现的技巧，其中源码的各种优秀设计修改，技术的发展既映射了历史，也凝结了人类实践工程的智慧。

这里简单的总结，学习源码可以获得什么：

- **满足好奇心**
- **提升个人认知**
- **提升代码水平**
## 二、如何学习源码

其实个人总结就3个字 **用、想、看**

1. 用
   首先我们在阅读某一个源码的时候，我们一定要先了解这个源码是**干什么**的

   **诞生背景、能够解决什么问题、为什么要用它**
   我应该**如何使用**它

2. 想
   想什么呢，首先我们要明确，这个源码的类型**是什么类型**
   常见的有：工具框架型（常见的工具包、网络、调度框架）、复杂完整系统型（linux操作系统、k8s、TIDB）

   我们需要根据不同的类型去区分我们的**侧重点**

   工具框架型：侧重点在它实现的功能，根据它提供的功能去思考如果是你来做你会怎么实现这个功能

   复杂完整系统型：侧重点在它的组件设计，它如何搭积木一样的把所有不同的组件组装起来形成一个复杂的完整系统的

   **在想这里我们一定要带着问题去思考，如果是我来做，我会怎么做，如果没有思路也没问题，因为最终我们都要转换问题**

   **它的实现和我的思路有什么不一样，那它是怎么实现的呢（利用了什么，如何组装，细节如何处理）**

3. 看

   当我们有了问题以后，我们需要的就是带着问题去看源码，一定要把自己的问题解决掉，当然我们在看的时候还会产生新的问题，但是我们一定要把握一个主线，也就是源码的主要功能。我们看源码有时候要看很多遍，先把问题记下来，**优先看主线**，当我们把握主线代码以后，再拆分每一层的细节，把你产生的问题再代入反复观看源码。

   **解决产生的问题，形成自己的理解，才可以融会贯通。**

当我们在观看源码的时候还需要特别注意如何去看，先看什么再看什么，有时候我们看源码可能跟了很多层自己就晕了，还有些时候不知道怎么看逻辑分支，是否会走到这里，那么这些实际上都是有一些看源码的技巧的。

## 三、看源码的技巧

这里以复杂完整系统型 [k8s](https://github.com/kubernetes/kubernetes)为例子

1. 掌握整体架构

   ![img](./源码的学习方式与技巧.assets/architecture.png)

2. 理解架构图，掌握关键组件信息
   这些其实在[k8s官网](https://kubernetes.io/zh-cn/docs/concepts/)均有提及
   图中关键组件其实就是:

   **kubectl、kube-apiserver、kube-controller-manager 、kube-scheduler、kubelet、kube-proxy、etcd**
   还有一些抽象概念为**node、pod、container**
   这时候我想你应该引起关注，这张图其实还有很多细节没有展现，但是随着学习我们需要自己发出提问

   比如：在上面的图中kubelet和apiserver是如何交互的、调度器又是如何和apiserver交互的？
   所以这里还会引出一个组件**client-go**

3. 看源码的目录结构

   | 源码目录      | 说明                                                         |
   | ------------- | ------------------------------------------------------------ |
   | cmd/          | 存放可执行文件的入口代码，每个可执行文件都会对应一个main函数 |
   | pkg/          | 存放核心库代码，可被项目内部或外部直接引用                   |
   | vendor/       | 存放项目依赖的库代码，一般为第三方库代码                     |
   | api/          | 存放OpenAPlSwagger的spec文件，包括JSON、Protocol 的定义等    |
   | build/        | 存放与构建相关的脚本                                         |
   | test/         | 存放测试工具及测试数据                                       |
   | docs/         | 存放设计或用户使用文档                                       |
   | hack/         | 存放与构建、测试等相关的脚本                                 |
   | third_party/  | 存放第三方工具、代码或其他组件                               |
   | plugin/       | 存放Kubernetes插件代码目录，例如认证，授权等相关插件         |
   | staging/      | 存放部分核心库的暂存目录                                     |
   | translations/ | 存放il8n (国际化)语言包的相关文件，可以在不修改内部代码的情况下支持不同语言及地区 |

   所以关键目录其实是*pkg*和*cmd*点开pkg我们可以看到以下目录

   | 目录或文件      | 作用                           |
   | :-------------- | :----------------------------- |
   | kubeapiserver   | Kubernetes API 服务器相关代码  |
   | kubectl         | Kubernetes 命令行工具相关代码  |
   | kubelet         | Kubernetes Kubelet 相关代码    |
   | proxy           | Kubernetes 代理相关代码        |
   | quota/v1        | Kubernetes 配额 API 相关代码   |
   | registry        | Kubernetes 组件注册表相关代码  |
   | routes          | 路由相关代码                   |
   | scheduler       | Kubernetes 调度器相关代码      |
   | volume          | 存储卷相关代码                 |
   | ...             | ...                            |

​		这里其实很明显就能看到我们看到的组件目录代码了，那这时候如果你再点开一个组件就是具体的组件源码了，每个组件都有自己的		内部组件设计。

4. 由点及面？由面到点？点（微观）面（宏观）结合！

   到这里我们就要进行拆分了，根据你观看源码的目的来进行区分。
   

   如果你是想了解某个组件是如何启动的，启动流程是什么？自己内部的组件是怎么启动的？有什么组件组成？那这里就是寻找程序入口

   当我们找到**main**函数以后，**我们一定要理清楚我们看源码的目的是什么，我想要知道什么。**
   大概流程如下：

   - 寻找main函数
   - 查看个个组件的初始化方法
   - 每个组件运行的方法
   - 查看每个组件实现的接口

   

   如果我们是想要了解 kubelet是怎么启动的？kubelet是怎么知道需要创建pod的？kubelet是怎么创建pod的？

   那我们就要寻找和你问题相关的代码，比如我要了解pod如何创建的，那我就要搜索关键词，一般创建的关键词都是create、new、open。其实创建关键词比较多，如果你找不到的话可以直接搜这个组件的关键词*pod*，然后去看和pod创建相关的关键词，从相似开始寻找即可。
   大概流程如下：

   - 寻找关键词
   - 寻找函数调用链
   - 是什么组件来维护的这个整体逻辑
   - 具体逻辑实现细节

   

   其实看多了源码以后，当我们很熟悉源码套路以后，只是想看其中一个功能的时候，可以直接从目录找名字然后随便点一个与我们想了解的功能相关的单词，开始跟源码。

   当跟源码跟晕的时候，需要**跳出现在的思维，如果我们是从宏观开始思考的那么这时候需要转变为从微观开始寻找答案，如果我们是从微观开始思考，那么这时候就要转变为从宏观开始寻找答案**

   **每个人的看源码方式是不一样的，所以需要大家根据习惯形成自己的一套看源码的方法论**

5. 尽量不要调试

   很多人在看代码初期，很容易不知道是不是走的这个分支，所以会借助debug来进行，这样虽然可以临时解决你的问题，但是长期下来，当我们无法调试的时候，那就跟不下去了，无法得出正确的结论。

   那这时候应该怎么办呢，其实应该**由下而上**，去不停的确认这个分支的变量判定到底是true还是false，这需要非常细腻的查看每一个判断，每一个成员变量的变更，到底是如何变更的，变更逻辑是什么，如何初始化的这个变量。什么情况下会变更？

   当我们不再借助debug，并且可以轻松的查看源码的时候，相信任何困难也就都难不倒你了

6. 学会总结，反复给自己提问
   当我们看源码解决完心中的一个问题的时候，其实会有更多的问题涌现出来。

   比如在k8s架构图里没有体现的很多细节，容器是如何启动的？我们都知道k8s有一些统一的标准定义：CSI、CRI、CNI 
   他们是如何使用的？
   这时候我们尽量不要跳过这些问题，记录下来，下次再来反复的**解决心中的疑问**，可以不停的给自己带来阅读源码的成就感，也就不再会觉得源码枯燥乏味无趣。

   当你**保持好奇心**，一切都会变的有趣起来。

   
